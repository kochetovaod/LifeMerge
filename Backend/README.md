# LifeMerge Backend Skeleton (Sprint 01)

Skeleton backend for MVP Sprint 01: Auth + Tasks.

## What is included
- FastAPI + autogenerated OpenAPI (Swagger)
- PostgreSQL (Docker)
- JWT auth (access + refresh) with refresh token rotation and device binding
- Middleware:
  - `X-Request-Id` propagation (generated if absent)
  - `X-Timezone` validation (IANA, falls back to UTC)
- Idempotency guard for write endpoints: require `request_id` in body OR `X-Idempotency-Key` header
- Soft delete + `updated_at` optimistic locking (409 on conflicts)

## Run (staging-like, locally)
Prerequisites: Docker + Docker Compose.

```bash
cd lifemerge-backend-skeleton
cp .env.example .env
# set a strong JWT_SECRET_KEY in .env
docker compose up --build
```

### Swagger
- Swagger UI: `http://localhost:8000/v1/docs`
- OpenAPI JSON: `http://localhost:8000/v1/openapi.json`

## Implemented endpoints
### Auth
- `POST /v1/auth/signup`
- `POST /v1/auth/login`
- `POST /v1/auth/refresh`
- `POST /v1/auth/forgot` (stub)
- `POST /v1/auth/reset` (stub)
- `POST /v1/auth/logout`

### Tasks
- `GET /v1/tasks` (cursor-based pagination)
- `POST /v1/tasks`
- `PATCH /v1/tasks/{id}`
- `DELETE /v1/tasks/{id}`

## Notes
- Tables are auto-created on startup for skeleton usage. Production should use Alembic migrations.
- Forgot/Reset are stubs by design in Sprint 01.
- AI planner now runs as a dedicated service (`ai-service`) reachable only inside the compose network. The main API
  authenticates with `X-AI-Internal-Token` to request batch plan generation. Scale the service for heavy batch loads via
  `docker compose up --scale ai-service=4` or adjust `deploy.replicas` in `docker-compose.yml`.

## Tests
- Unit + integration tests use `pytest` with async support for API routes and a SQLite-backed test database.
- Run all backend tests: `pytest`
